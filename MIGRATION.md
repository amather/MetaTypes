# MetaTypes Migration Guide - August 2025

This guide covers the significant architectural changes implemented in August 2025. These changes introduce a unified vendor-based generator architecture with an orchestrated configuration system.

## ‚úÖ Migration Status: COMPLETED

**As of August 10th, 2025**: All migration issues have been resolved and the new architecture is fully functional:

- ‚úÖ **Configuration Format**: Corrected and working  
- ‚úÖ **Vendor Architecture**: EfCore vendor generation working properly  
- ‚úÖ **Discovery Methods**: All methods functioning properly  
- ‚úÖ **Generated Files**: Using default .NET source generator locations  
- ‚úÖ **Sample Projects**: All building and running successfully
- ‚úÖ **Vendor Pattern Fix**: EfCore projects now correctly generate only vendor extensions, not full base classes

### Latest Fixes (August 10th)
- **Fixed vendor project configuration**: EfCore projects now use `BaseMetaTypes: false` to generate only partial vendor extensions
- **Corrected discovery method filtering**: Vendor projects only include vendor-specific discovery methods  
- **Resolved duplicate base class generation**: Base classes are generated by main projects, vendor extensions by vendor projects

## üö® Breaking Changes

### 1. Default Configuration Values Changed

**CRITICAL**: The default behavior for generators has changed significantly:

| Setting | Old Default | New Default | Impact |
|---------|------------|-------------|---------|
| `BaseMetaTypes` | `true` (base generator) | `false` (all generators) | **Base types won't generate by default** |
| `CrossAssembly` | `true` (EfCore generator) | `false` (all generators) | **Cross-assembly discovery disabled by default** |

### 2. Configuration File Format Changed

**OLD FORMAT** (no longer supported):
```json
{
  "AssemblyName": "MyProject",
  "EnableDiagnosticFiles": true
}
```

**NEW FORMAT** (current working format):
```json
{
  "MetaTypes.Generator": {
    "EnableDiagnosticFiles": true,
    "Generation": {
      "BaseMetaTypes": true
    },
    "Discovery": {
      "Syntax": true,
      "CrossAssembly": true,
      "Methods": ["MetaTypes.Attribute", "MetaTypes.Reference"]
    }
  }
}
```

**For main projects with EfCore entities** (generates base + vendor extensions):
```json
{
  "MetaTypes.Generator": {
    "EnableDiagnosticFiles": true,
    "Generation": {
      "BaseMetaTypes": true
    },
    "Discovery": {
      "Syntax": true,
      "CrossAssembly": true,
      "Methods": [
        "MetaTypes.Attribute", 
        "MetaTypes.Reference",
        "EfCore.TableAttribute",
        "EfCore.DbContextSet"
      ]
    },
    "Vendors": {
      "EfCore": {
        "RequireBaseTypes": true,
        "IncludeNavigationProperties": true,
        "IncludeForeignKeys": true
      }
    }
  }
}
```

**For dedicated EfCore vendor projects** (generates only vendor extensions):
```json
{
  "MetaTypes.Generator": {
    "EnableDiagnosticFiles": true,
    "Generation": {
      "BaseMetaTypes": false
    },
    "Discovery": {
      "Syntax": true,
      "CrossAssembly": true,
      "Methods": [
        "EfCore.TableAttribute",
        "EfCore.DbContextSet"
      ]
    },
    "Vendors": {
      "EfCore": {
        "RequireBaseTypes": true,
        "IncludeNavigationProperties": true,
        "IncludeForeignKeys": true
      }
    }
  }
}
```

## üîß Migration Steps

### Step 1: Update Configuration File

1. **Locate** your `metatypes.config.json` file
2. **Replace** the entire contents with the new format
3. **Configure** each generator section explicitly

**For basic projects:**
```json
{
  "MetaTypes.Generator": {
    "EnableDiagnosticFiles": true,
    "Generation": {
      "BaseMetaTypes": true
    },
    "Discovery": {
      "Syntax": true,
      "CrossAssembly": true,
      "Methods": ["MetaTypes.Attribute", "MetaTypes.Reference"]
    }
  }
}
```

**For main projects with EfCore entities:**
```json
{
  "MetaTypes.Generator": {
    "EnableDiagnosticFiles": true,
    "Generation": {
      "BaseMetaTypes": true
    },
    "Discovery": {
      "Syntax": true,
      "CrossAssembly": true,
      "Methods": [
        "MetaTypes.Attribute", 
        "MetaTypes.Reference",
        "EfCore.TableAttribute",
        "EfCore.DbContextSet"
      ]
    },
    "Vendors": {
      "EfCore": {
        "RequireBaseTypes": true,
        "IncludeNavigationProperties": true,
        "IncludeForeignKeys": true
      }
    }
  }
}
```

**For dedicated EfCore vendor projects:**
```json
{
  "MetaTypes.Generator": {
    "EnableDiagnosticFiles": true,
    "Generation": {
      "BaseMetaTypes": false
    },
    "Discovery": {
      "Syntax": true,
      "CrossAssembly": true,
      "Methods": [
        "EfCore.TableAttribute",
        "EfCore.DbContextSet"
      ]
    },
    "Vendors": {
      "EfCore": {
        "RequireBaseTypes": true,
        "IncludeNavigationProperties": true,
        "IncludeForeignKeys": true
      }
    }
  }
}
```

### Step 2: Verify Generation Still Works

After updating your configuration:

1. **Clean** your project: `dotnet clean`
2. **Rebuild** your project: `dotnet build`
3. **Check** that MetaTypes are still being generated
4. **Verify** all your existing MetaTypes classes are available

### Step 3: Enable Cross-Assembly Discovery (If Needed)

If your project discovers types from referenced assemblies, ensure `CrossAssembly: true` is set:

```json
{
  "MetaTypes.Generator": {
    "Discovery": {
      "CrossAssembly": true  // ‚Üê Must be explicit now
    }
  }
}
```

### Step 4: Configure Custom Namespace (Optional)

To override the default namespace for generated types, use `GeneratedNamespace`:

```json
{
  "MetaTypes.Generator": {
    "GeneratedNamespace": "MyApp.Generated",
    "Generation": {
      "BaseMetaTypes": true
    }
  }
}
```

This replaces the old `AssemblyName` configuration option.

## üèóÔ∏è New Vendor-Based Architecture

### Unified Generator System
- **Single Generator** (`MetaTypes.Generator`): Handles all generation via vendor plugins
- **Vendor Plugins**: Extend base types with vendor-specific metadata (e.g., EfCore)
- **Discovery Methods**: Pluggable discovery system finds types using various strategies

### Available Discovery Methods
- **`"MetaTypes.Attribute"`**: Find types with `[MetaType]` attribute
- **`"MetaTypes.Reference"`**: Find types referenced by other MetaTypes  
- **`"EfCore.TableAttribute"`**: Find EF Core entities via `[Table]` attribute syntax analysis
- **`"EfCore.DbContextSet"`**: Find entity types by scanning `DbContext` `DbSet<T>` properties

### Vendor Configuration Patterns

**Two-Generator Pattern (Recommended):**
1. **Main Project**: `BaseMetaTypes: true` + all discovery methods ‚Üí generates base MetaType classes
2. **Vendor Project**: `BaseMetaTypes: false` + vendor discovery methods only ‚Üí generates partial vendor extensions

**Single-Generator Pattern:**
1. **One Project**: `BaseMetaTypes: true` + all discovery methods ‚Üí generates both base and vendor extensions

### Vendor Extensions
- **EfCore Vendor**: Generates `IMetaTypeEfCore` extensions with table names, keys, foreign keys
- **Generated Files**: 
  - Base types: `TestEntityMetaType.g.cs` (complete `IMetaType<T>` implementation)
  - Vendor extensions: `TestEntityEfCoreMetaType.g.cs` (partial class implementing `IMetaTypeEfCore`)
- **Namespace Coordination**: Vendor extensions use partial classes in the same namespace as base types

## ‚ö° Performance Improvements

- **Unified Discovery**: All generators now share the same discovery logic
- **Configurable Methods**: Disable unused discovery methods for faster builds
- **Coordinated Generation**: Eliminates duplicate type generation

## üîç Troubleshooting

### Issue: No MetaTypes Generated After Migration

**Cause**: `BaseMetaTypes` defaults to `false`  
**Solution**: Explicitly set `"BaseMetaTypes": true` in your base generator config

### Issue: Cross-Assembly Types Missing

**Cause**: `CrossAssembly` defaults to `false`  
**Solution**: Set `"CrossAssembly": true` in discovery configuration

### Issue: EfCore Extensions Missing

**Cause**: EfCore vendor not configured or base types not available  
**Solution**: 
- For two-generator pattern: Configure main project with `BaseMetaTypes: true` and vendor project with `BaseMetaTypes: false`
- For single-generator pattern: Set `BaseMetaTypes: true` and include EfCore discovery methods
- Ensure EfCore vendor has `"RequireBaseTypes": true`

### Issue: Configuration Not Loading

**Cause**: File not properly marked as `AdditionalFiles` in project  
**Solution**: Verify your `.csproj` has:
```xml
<ItemGroup>
  <AdditionalFiles Include="metatypes.config.json" Type="MetaTypes.Generator.Options" />
  <CompilerVisibleItemMetadata Include="AdditionalFiles" MetadataName="Type" />
</ItemGroup>
```

## üìã Migration Checklist

- [ ] Updated `metatypes.config.json` to new format
- [ ] Explicitly configured `BaseMetaTypes: true` for base generation
- [ ] Set `CrossAssembly: true` if using cross-assembly discovery
- [ ] Verified project builds successfully
- [ ] Confirmed MetaTypes are still generated
- [ ] Tested runtime functionality
- [ ] Reviewed generated code for correctness

## üÜò Getting Help

If you encounter issues during migration:

1. **Check the logs**: Enable `"EnableDiagnosticFiles": true` to see detailed generator diagnostics
2. **Verify configuration**: Use the exact format shown in the examples above
3. **Clean rebuild**: Always clean and rebuild after configuration changes
4. **Reference samples**: Check working configurations in:
   - `samples/Sample.Console/metatypes.config.json` (basic single-generator)
   - `samples/Vendor/EfCore/Sample.EfCore.LocalOnly/metatypes.config.json` (dedicated vendor generator)
   - `samples/Vendor/EfCore/Sample.EfCore.Infrastructure/metatypes.config.json` (main generator with EfCore)

## üéØ Current Working Examples

**All sample projects are now fully functional:**
- ‚úÖ `samples/Sample.Console` - Basic MetaTypes generation
- ‚úÖ `samples/Vendor/EfCore/Sample.EfCore.LocalOnly` - Full EfCore vendor generation  
- ‚úÖ `samples/Vendor/EfCore/Sample.EfCore.Infrastructure` - Infrastructure-only MetaTypes

**Generated files are in default .NET locations:**
- `obj/Debug/net{version}/generated/MetaTypes.Generator/MetaTypes.Generator.MetaTypeSourceGenerator/`

---

*Migration completed August 10th, 2025. The vendor-based architecture provides a unified, extensible system for MetaTypes generation while maintaining full backward compatibility.*